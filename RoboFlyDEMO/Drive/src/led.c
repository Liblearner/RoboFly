/*******************************************************************************************
										    �� ��
    ����Ŀ�����������ѧϰʹ�ã�����������ֲ�޸ģ������뱣����������Ϣ����ֲ�����г�������
	
���ɹ�����BUG��������������κ����Ρ��������ã�

* ����汾��V1.01
* �������ڣ�2018-8-18
* �������ߣ���ŭ��С��
* ��Ȩ���У��������������Ϣ�������޹�˾
*******************************************************************************************/
#include "stm32f10x.h"
#include "stdlib.h"
#include "delay.h"
#include "structconfig.h"

#define   RGB_H     GPIOB->BSRR |= GPIO_Pin_9   //���ö�ӦRGB����Ϊ �ߵ�ƽ
#define   RGB_L     GPIOB->BRR  |= GPIO_Pin_9	//���ö�ӦRGB����Ϊ �͵�ƽ

//������RGB��Ԫɫ����߲�������
static u32 Run_buf[][16] = 
{
	{0xFFA500,0,0,0,0xFFA500,0,0,0,0xFFA500,0,0,0,0xFFA500,0,0,0,},//��ɫ
	{0x00FF00,0,0,0,0x00FF00,0,0,0,0x00FF00,0,0,0,0x00FF00,0,0,0,},//��ɫ
	{0xFF00FF,0,0,0,0xFF00FF,0,0,0,0xFF00FF,0,0,0,0xFF00FF,0,0,0,},//��ɫ
	{0x00FFFF,0,0,0,0x00FFFF,0,0,0,0x00FFFF,0,0,0,0x00FFFF,0,0,0,},//��ɫ
	{0x0000FF,0,0,0,0x0000FF,0,0,0,0x0000FF,0,0,0,0x0000FF,0,0,0,},//��ɫ
	{0xFFFF00,0,0,0,0xFFFF00,0,0,0,0xFFFF00,0,0,0,0xFFFF00,0,0,0,},//��ɫ
	{0xFFFFFF,0,0,0,0xFFFFFF,0,0,0,0xFFFFFF,0,0,0,0xFFFFFF,0,0,0,},//��ɫ
	
};

uint8_t Run_flag=1;//�����Ʊ�־

/***************************************************************************
* ��  ����void LED_Init(void)
* ��  �ܣ��û�ָʾ�����ų�ʼ��
* ��  ������
* ����ֵ����
* ��  ע: RGB���ų�ʼ����MCUָʾ�����ų�ʼ��
***************************************************************************/
void LED_Init(void)
{
	GPIO_InitTypeDef GPIO_InitStruct;   
	
	RCC_APB2PeriphClockCmd(RCC_APB2Periph_GPIOB,ENABLE);   
	
	GPIO_InitStruct.GPIO_Pin=GPIO_Pin_8|GPIO_Pin_9; 
	GPIO_InitStruct.GPIO_Mode=GPIO_Mode_Out_PP;	//�������
	GPIO_InitStruct.GPIO_Speed=GPIO_Speed_50MHz;  
	GPIO_Init(GPIOB,&GPIO_InitStruct);
	
	GPIO_SetBits(GPIOB,GPIO_Pin_8);
	GPIO_ResetBits(GPIOB,GPIO_Pin_9);
}

/***************************************************************************
* ��  ����void LED_Run(void)
* ��  �ܣ�ָʾMCU�Ƿ���
* ��  ������
* ����ֵ����
* ��  ע: LED��˸MCU��������
***************************************************************************/
void LED_Run(void)
{
	static uint8_t flag = 1;
	if(flag)
	{
		flag = 0;
		GPIO_SetBits(GPIOB,GPIO_Pin_8);
	}
	else
	{
		flag = 1;
		GPIO_ResetBits(GPIOB,GPIO_Pin_8);
	}
}

/********************************************************************************
* ��  ����void Write0(void)
* ��  �ܣ�д 0�� ����
* ��  ������
* ����ֵ����
* ��  ע: ����RGB���ֲ��� ��RGB_H ��ʱ 300ns��RGB_L ��ʱ 900ns
*		  RGB_H��RGB_L֮�����ʱ�����ݲ�ͬоƬ����Ƶʵ�ʵ���__nop()�����ĸ���	  
*********************************************************************************/
void Write0(void)
{
	RGB_H;
	__nop();__nop();__nop();__nop();__nop();__nop();
	
	RGB_L;
	__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();
	__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();
	__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();
	__nop();__nop();
}


/********************************************************************************
* ��  ����void Write1(void)
* ��  �ܣ�д 1�� ����
* ��  ������
* ����ֵ����
* ��  ע: ����RGB���ֲ��� ��RGB_H ��ʱ 600ns��RGB_L ��ʱ 600ns
*		  RGB_H��RGB_L֮�����ʱ�����ݲ�ͬоƬ����Ƶʵ�ʵ���__nop()�����ĸ���	  
*********************************************************************************/
void Write1(void)
{
	RGB_H;
	__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();
	__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();
	__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();
	__nop();__nop();
	
	RGB_L;
	__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();__nop();
}

/***************************************************************************
* ��  ����void RGB_WByte(uint8_t byte)
* ��  �ܣ�дһ���ֽڣ�8bit������
* ��  ����byte 
* ����ֵ: ��
* ��  ע: RGB������ͨ������ 0x01 ����ֵ���е���
***************************************************************************/
void RGB_WByte(uint8_t byte)
{
	uint8_t i=0;
	for(i=0;i<8;i++)
	{
	  if((byte<<i)&0x01)
		  Write1();
	  else
		  Write0();
	}
}

/***************************************************************************
* ��  ����void Write24Bit(uint8_t green, uint8_t red, uint8_t blue)
* ��  �ܣ�����һ��RGB�Ƶ�ɫ��
* ��  ����green red blue������������ռ������С,��Χ0~255
* ����ֵ: ��
* ��  ע: ������˳��ΪGRB��ÿ����ɫռ8λ���ݣ����һ������Ҫд24λ����
***************************************************************************/
void Write24Bit(uint8_t green, uint8_t red, uint8_t blue)
{
	RGB_WByte(green);
	RGB_WByte(red);
	RGB_WByte(blue);
}

/**************************************************************************
* ��  ����void RGB_LED_Rand(void)
* ��  �ܣ�����任��ɫ
* ��  ������
* ����ֵ����
* ��  ע: ȡģ��ΧԽ��ɫ������Խ��
**************************************************************************/
void RGB_LED_Rand(void)
{
	uint8_t i,red=0,green=0,blue=0;;
	for(i=0;i<4;i++)
	{
		green = rand()%18+2;//����һ��0~20�������
		red   = rand()%18+2;
		blue  = rand()%18+2;
		Write24Bit(green,red,blue);//�ϳ���ɫ
	}  
}

/**************************************************************************
* ��  ����void RGB_LED_Runing(void)
* ��  �ܣ�������
* ��  ������
* ����ֵ����
* ��  ע: ��
**************************************************************************/
void RGB_LED_Runing(void)
{
	uint8_t i,red=0,green=0,blue=0;
	static uint8_t cnt = 0,wcnt = 0,times = 0;
	if(times++ >= 16)
	{
	 times = 0; 
	 wcnt++;
	}
	for(i=0;i<4;i++)
	{
		if(cnt>4) cnt = 0;
		red   = ((Run_buf[wcnt][cnt]>>16)&0xff);
		green = ((Run_buf[wcnt][cnt]>>8)&0xff); 
		blue  = ((Run_buf[wcnt][cnt]>>0)&0xff);
		Write24Bit(green,red,blue);//�ϳ���ɫ
		cnt++;
	}
	if(wcnt==7) wcnt = 0;  
}

/**************************************************************************
* ��  ����void RGB_LED_Red(void)
* ��  �ܣ����
* ��  ������
* ����ֵ����
* ��  ע�����кܶ�����ɫ�����Լ���������
**************************************************************************/
void RGB_LED_Red(void)
{
	uint8_t i;
	for(i=0;i<4;i++)
	{
		Write24Bit(0,0xff,0);
	}
}

/**************************************************************************
* ��  ����void RGB_LED_Orange(void)
* ��  �ܣ��ȵ�
* ��  ������
* ����ֵ����
* ��  ע: ��
**************************************************************************/
void RGB_LED_Orange(void)
{
	uint8_t i;
	for(i=0;i<4;i++)
	{
		Write24Bit(0xa5,0xff,0x00);
	}
}

/**************************************************************************
* ��  ����void RGB_LED_Yellow(void)
* ��  �ܣ��Ƶ�
* ��  ������
* ����ֵ����
* ��  ע: ��
**************************************************************************/
void RGB_LED_Yellow(void)
{
	uint8_t i;
	for(i=0;i<4;i++)
	{
		Write24Bit(0xff,0xff,0);
	}
}

/**************************************************************************
* ��  ����void RGB_LED_green(void)
* ��  �ܣ��̵�
* ��  ������
* ����ֵ����
* ��  ע: ��
**************************************************************************/
void RGB_LED_green(void)
{
	uint8_t i;
	for(i=0;i<4;i++)
	{
		Write24Bit(0xff,0,0);
	}
}

/**************************************************************************
* ��  ����void RGB_LED_Cyan(void)
* ��  �ܣ����
* ��  ������
* ����ֵ����
* ��  ע: ��
**************************************************************************/
void RGB_LED_Cyan(void)
{
	uint8_t i;
	for(i=0;i<4;i++)
	{
		Write24Bit(0xff,0,0xff);
	}
}

/**************************************************************************
* ��  ����void RGB_LED_Blue(void)
* ��  �ܣ�����
* ��  ������
* ����ֵ����
* ��  ע: ��
**************************************************************************/
void RGB_LED_Blue(void)
{
	uint8_t i;
	for(i=0;i<4;i++)
	{
		Write24Bit(0,0,0xff);
	}
}

/**************************************************************************
* ��  ����void RGB_LED_Violet(void)
* ��  �ܣ��ϵ�
* ��  ������
* ����ֵ����
* ��  ע: ��
**************************************************************************/
void RGB_LED_Violet(void)
{
	uint8_t i;
	for(i=0;i<4;i++)
	{
		Write24Bit(0x00,0xcd,0xcd);
	}
}

/**************************************************************************
* ��  ����void RGB_LED_FLY(void)
* ��  �ܣ���������
* ��  ������
* ����ֵ����
* ��  ע: ��
**************************************************************************/
void RGB_LED_FLY(void)
{
	uint8_t i;
	for(i=0;i<4;i++)
	{
		if(i<2)
			Write24Bit(0xff,0,0);
		else
			Write24Bit(0,0xff,0);
	}
}

/**************************************************************************
* ��  ����void RGB_LED_White(void)
* ��  �ܣ��׵�
* ��  ������
* ����ֵ����
* ��  ע: ��
**************************************************************************/
void RGB_LED_White(void)
{
	uint8_t i;
	for(i=0;i<4;i++)
	{
		Write24Bit(0xff,0xff,0xff);
	}
}

/**************************************************************************
* ��  ����void RGB_LED_Off(void)
* ��  �ܣ�����
* ��  ������
* ����ֵ����
* ��  ע: ��
**************************************************************************/
void RGB_LED_Off(void)
{
	uint8_t i;
	for(i=0;i<4;i++)
	{
		Write24Bit(0,0,0);
	}
}

/**************************************************************************
* ��  ����void GYRO_Offset_LED(void)
* ��  �ܣ�������У׼���������˸
* ��  ������
* ����ֵ����
* ��  ע: ��
**************************************************************************/
void GYRO_Offset_LED(void)
{
	 RGB_LED_Off();
	 RGB_LED_Blue();
	 Delay_ms(100);
	 RGB_LED_Off();
	 Delay_ms(100);
	 RGB_LED_Blue();
	 Delay_ms(100);
	 RGB_LED_Off();
	 Delay_ms(100);
	 RGB_LED_Blue();
	 Delay_ms(100);
	 RGB_LED_Off();
}

/**************************************************************************
* ��  ����void ACC_Offset_LED(void)
* ��  �ܣ����ٶ�У׼����̵���˸
* ��  ������
* ����ֵ����
* ��  ע: ��
**************************************************************************/
void ACC_Offset_LED(void)
{
	 RGB_LED_Off();
	 RGB_LED_green();
	 Delay_ms(100);
	 RGB_LED_Off();
	 Delay_ms(100);
	 RGB_LED_green();
	 Delay_ms(100);
	 RGB_LED_Off();
	 Delay_ms(100);
	 RGB_LED_green();
	 Delay_ms(100);
	 RGB_LED_Off();
}

/**************************************************************************
* ��  ����void BAR_Offset_LED(void)
* ��  �ܣ���ѹ��У׼����ϵ���˸
* ��  ������
* ����ֵ����
* ��  ע: ��
**************************************************************************/
void BAR_Offset_LED(void)
{
	 RGB_LED_Off();
	 RGB_LED_Violet();
	 Delay_ms(100);
	 RGB_LED_Off();
	 Delay_ms(100);
	 RGB_LED_Violet();
	 Delay_ms(100);
	 RGB_LED_Off();
	 Delay_ms(100);
	 RGB_LED_Violet();
	 Delay_ms(100);
	 RGB_LED_Off();
}

/**************************************************************************
* ��  ����void BATT_Alarm_LED(void)
* ��  �ܣ��͵�����ƿ���
* ��  ������
* ����ֵ����
* ��  ע: ��
**************************************************************************/
void BATT_Alarm_LED(void)
{
	static uint8_t flag = 0;
	if(BATT_LEDflag)
	{
		if(flag)
		{
			flag = 0;
			RGB_LED_Red();
		}
		else
		{
			flag = 1;
			RGB_LED_Off();
		}
	}
}


